@if (Comments.Count == 0)
{
    <div class="comment-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
        </svg>
        <p>暂无评论，来抢沙发吧</p>
    </div>
}
else
{
    <div class="comment-list">
        @foreach (var item in Comments)
        {
            <div class="comment-item" id="@item.Id">
                <div class="comment-item__avatar">
                    <Avatar Commenter="@item.Commenter"></Avatar>
                </div>
                <div class="comment-item__body">
                    <div class="comment-item__header">
                        <ShowNickName Commenter="@item.Commenter"></ShowNickName>
                        <time class="timeago comment-item__date" datetime="@item.PublishTime" title="@item.PublishTime">@item.PublishTime.TimeAgo()</time>
                    </div>
                    
                    <div class="comment-item__content markdown-body">
                        @{
                            var commentContent = new CommentContentModel
                            {
                                CommentText = item.CommentText
                            };
                        }
                        <CommentText Content="@commentContent"></CommentText>
                    </div>

                    <div class="comment-item__actions">
                        @if (item.IsDelete != true)
                        {
                            <button class="comment-item__reply-btn" title="回复" @onclick="() => OnReply.InvokeAsync(item.Id)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="15,10 20,15 15,20"></polyline>
                                    <path d="M4 4v7a4 4 0 0 0 4 4h12"></path>
                                </svg>
                                回复
                            </button>
                        }
                    </div>

                    @if (ReplyId == item.Id)
                    {
                        <CommentForm Node="@item.Node" Relation="@item.Relation" ReplyId="@item.Id" SendCommentAsync="SendCommentAsync" OnCancelReply="OnCancelReply"></CommentForm>
                    }

                    @if (item.Children.Count > 0)
                    {
                        <div class="comment-replies">
                            @foreach (var reply in item.Children)
                            {
                                var replier = Comments.FirstOrDefault(x => x.Id == reply.Replies.Last());
                                var replier2 = item.Children.FirstOrDefault(x => x.Id == reply.Replies.Last());
                                
                                <div class="comment-item" id="@reply.Id">
                                    <div class="comment-item__avatar">
                                        <Avatar Commenter="@reply.Commenter"></Avatar>
                                    </div>
                                    <div class="comment-item__body">
                                        <div class="comment-item__header">
                                            <ShowNickName Commenter="@reply.Commenter"></ShowNickName>
                                            <time class="timeago comment-item__date" datetime="@reply.PublishTime" title="@reply.PublishTime">@reply.PublishTime.TimeAgo()</time>
                                        </div>
                                        
                                        <div class="comment-item__content markdown-body">
                                            @{
                                                var content = new CommentContentModel
                                                {
                                                    CommentText = reply.CommentText
                                                };
                                                if (replier != null)
                                                {
                                                    content.ReplyId = replier.Id;
                                                    content.ReplyNickName = replier.Commenter.NickName;
                                                }
                                                else if (replier2 != null)
                                                {
                                                    content.ReplyId = replier2.Id;
                                                    content.ReplyNickName = replier2.Commenter.NickName;
                                                }
                                            }
                                            <CommentText Content="@content"></CommentText>
                                        </div>
                                        
                                        <div class="comment-item__actions">
                                            @if (reply.IsDelete != true)
                                            {
                                                <button class="comment-item__reply-btn" title="回复" @onclick="() => OnReply.InvokeAsync(reply.Id)">
                                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <polyline points="15,10 20,15 15,20"></polyline>
                                                        <path d="M4 4v7a4 4 0 0 0 4 4h12"></path>
                                                    </svg>
                                                    回复
                                                </button>
                                            }
                                        </div>

                                        @if (ReplyId == reply.Id)
                                        {
                                            <CommentForm Node="@item.Node" Relation="@item.Relation" ReplyId="@reply.Id" SendCommentAsync="SendCommentAsync" OnCancelReply="OnCancelReply"></CommentForm>
                                        }

                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
    @if (CurrentPageIndex < TotalPageCount)
    {
        <div class="comment-load-more">
            @if (_loadNextPage)
            {
                <div class="comment-loading-spinner">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
                        <path d="M21 12a9 9 0 11-6.219-8.56"></path>
                    </svg>
                    <span>加载中...</span>
                </div>
            }
            else
            {
                <button class="comment-load-more__btn" @onclick="NextAsync">加载更多...</button>
            }
        </div>
    }
}
