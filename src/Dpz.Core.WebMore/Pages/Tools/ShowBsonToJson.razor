@page "/tools/bson-to-json"
@layout ToolsLayout

<PageTitle>显示BSON 转 JSON - 个人文章分享</PageTitle>

<div class="bson-tool">
    <div class="bson-tool__header">
        <div class="bson-tool__title-group">
            <h1 class="bson-tool__title">BSON TO JSON</h1>
            <div class="bson-tool__title-accent"></div>
        </div>
        <p class="bson-tool__subtitle">/// CONVERT • PARSE • INSPECT BSON DATA</p>
    </div>

    <div class="bson-tool__section">
        <div class="bson-tool__label-bar">
            <span class="bson-tool__section-label">
                <i class="fa-solid fa-upload"></i> FILE UPLOAD
            </span>
        </div>
        
        <div class="bson-tool__upload-area">
            <InputFile OnChange="OnSelectedFile" class="bson-tool__file-input" accept=".bson" disabled="@_isProcessing" />
            <div class="bson-tool__upload-content">
                @if (_isProcessing)
                {
                    <i class="fa-solid fa-spinner fa-spin bson-tool__upload-icon"></i>
                    <div class="bson-tool__upload-text">PROCESSING...</div>
                }
                else
                {
                    <i class="fa-solid fa-cloud-arrow-up bson-tool__upload-icon"></i>
                    <div class="bson-tool__upload-text">点击或拖拽 BSON 文件到此处</div>
                    <div class="bson-tool__upload-hint">支持 .bson 格式文件 (最大 @(Helper.AppTools.MaxFileSize / 1024 / 1024)MB)</div>
                }
            </div>
        </div>
        
        @if (_fileSize > 0)
        {
            <div class="bson-tool__file-info">
                <i class="fa-solid fa-file-code"></i>
                <span class="bson-tool__file-info-label">FILE SIZE:</span>
                <span class="bson-tool__file-info-value">@($"{_fileSize:N0}") bytes</span>
            </div>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="bson-tool__error">
                <div class="bson-tool__error-icon">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                </div>
                <div class="bson-tool__error-content">
                    <strong>ERROR</strong>
                    <span>@_errorMessage</span>
                </div>
            </div>
        }
    </div>

    <div class="bson-tool__section">
        <div class="bson-tool__label-bar">
            <span class="bson-tool__section-label">
                <i class="fa-solid fa-clock"></i> OBJECTID TIMESTAMP
            </span>
        </div>
        
        <div class="bson-tool__input-group">
            <input type="text" 
                   @bind="_objectIdValue" 
                   @bind:event="oninput"
                   @bind:after="OnObjectIdValueChange"
                   class="bson-tool__input" 
                   placeholder="输入 ObjectId 以查看创建时间..." />
        </div>

        @if (_parseObjectIdSuccess.HasValue)
        {
            @if (_parseObjectIdSuccess == true && _objectId != null)
            {
                <div class="bson-tool__result-card">
                    <div class="bson-tool__result-row">
                        <span class="bson-tool__result-label">
                            <i class="fa-solid fa-globe"></i> UTC TIME
                        </span>
                        <span class="bson-tool__result-value">@_objectId.Value.CreationTime.ToUniversalTime().ToString("yyyy/MM/dd HH:mm:ss")</span>
                    </div>
                    <div class="bson-tool__result-row">
                        <span class="bson-tool__result-label">
                            <i class="fa-solid fa-location-dot"></i> LOCAL TIME
                        </span>
                        <span class="bson-tool__result-value">@_objectId.Value.CreationTime.ToLocalTime().ToString("yyyy/MM/dd HH:mm:ss")</span>
                    </div>
                    <div class="bson-tool__result-row">
                        <span class="bson-tool__result-label">
                            <i class="fa-solid fa-hashtag"></i> TIMESTAMP
                        </span>
                        <span class="bson-tool__result-value">@_objectId.Value.Timestamp.ToString("N")</span>
                    </div>
                </div>
            }
            else if (_parseObjectIdSuccess == false)
            {
                <div class="bson-tool__error bson-tool__error--inline">
                    <div class="bson-tool__error-icon">
                        <i class="fa-solid fa-circle-xmark"></i>
                    </div>
                    <div class="bson-tool__error-content">
                        <span>ObjectId 格式无效</span>
                    </div>
                </div>
            }
        }
    </div>

    @if (_bsonValue != "{}")
    {
        <div class="bson-tool__section">
            <div class="bson-tool__label-bar">
                <span class="bson-tool__section-label">
                    <i class="fa-solid fa-code"></i> JSON OUTPUT
                </span>
                <div class="bson-tool__actions">
                    <button @onclick="CopyToClipboardAsync" class="bson-tool__btn bson-tool__btn--secondary" disabled="@_isProcessing">
                        <i class="fa-solid fa-copy"></i>
                        <span>COPY</span>
                    </button>
                    <button @onclick="DownloadAsync" class="bson-tool__btn bson-tool__btn--primary" disabled="@_isProcessing">
                        <i class="fa-solid fa-download"></i>
                        <span>DOWNLOAD</span>
                    </button>
                </div>
            </div>
            
            <div class="bson-tool__code-container">
                @* 使用 @key 强制 Blazor 在内容更新时重新创建 DOM 元素，防止 Prism.js 修改 DOM 后导致的渲染冲突 *@
                <pre @key="@_renderKey"><code class="language-json">@_bsonValue</code></pre>
            </div>
        </div>
    }
</div>
